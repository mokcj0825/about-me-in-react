{
  "id": "candle_of_delayed_diffraction",
  "name": "Candle of Delayed Diffraction",
  "description": "After characters use an AoE ATK ability, their ATK increases by 30.0% lasting for 2 turn(s).",
  "rarity": 1,
  "category": "offense",
  "implementation": {
    "data_structures": {
      "buff": {
        "id": "candle_atk_buff",
        "type": "stat_modifier",
        "stat": "atk",
        "value": 30,
        "value_type": "percentage",
        "duration": 2,
        "stack_type": "refresh",
        "trigger": "after_aoe"
      },
      "event_types": [
        "ability_used",
        "buff_applied",
        "buff_removed",
        "turn_start",
        "turn_end"
      ],
      "required_interfaces": {
        "BuffManager": {
          "methods": [
            "applyBuff(target: Unit, buff: Buff): void",
            "removeBuff(target: Unit, buffId: string): void",
            "updateBuffDurations(unit: Unit): void",
            "getActiveBuffs(unit: Unit): Buff[]"
          ]
        },
        "AbilityHandler": {
          "methods": [
            "isAoeAbility(ability: Ability): boolean",
            "handleAbilityUsed(actor: Unit, ability: Ability, targets: Unit[]): void"
          ]
        }
      }
    },
    "event_flow": [
      {
        "trigger": "ability_used",
        "checks": [
          "Is ability AoE or splash type?",
          "Does user have candle_of_delayed_diffraction blessing?",
          "Is ability an attack type?"
        ],
        "actions": [
          "Create new ATK buff instance",
          "Apply buff to ability user",
          "Emit buff_applied event"
        ]
      },
      {
        "trigger": "turn_end",
        "actions": [
          "Update buff durations",
          "Remove expired buffs",
          "Emit buff_removed event if buff expires"
        ]
      }
    ],
    "pseudocode": {
      "buff_application": [
        "function handleAbilityUsed(event: AbilityUsedEvent) {",
        "  if (!isAoeAbility(event.ability)) return;",
        "  if (!hasBlessing(event.actor, 'candle_of_delayed_diffraction')) return;",
        "  if (!isAttackAbility(event.ability)) return;",
        "  ",
        "  const buff = createBuff({",
        "    id: 'candle_atk_buff',",
        "    value: 30,",
        "    duration: 2",
        "  });",
        "  ",
        "  buffManager.applyBuff(event.actor, buff);",
        "  emitEvent('buff_applied', { target: event.actor, buff });",
        "}"
      ],
      "buff_update": [
        "function handleTurnEnd(event: TurnEndEvent) {",
        "  for (const unit of getAllUnits()) {",
        "    const expiredBuffs = buffManager.updateBuffDurations(unit);",
        "    for (const buff of expiredBuffs) {",
        "      buffManager.removeBuff(unit, buff.id);",
        "      emitEvent('buff_removed', { target: unit, buff });",
        "    }",
        "  }",
        "}"
      ]
    }
  },
  "validation": {
    "success_conditions": [
      "Player unit's ATK increases by 30% after using an AoE attack ability",
      "ATK buff lasts for exactly 2 turns",
      "ATK buff is applied immediately after the AoE ability is used",
      "ATK buff stacks multiplicatively with other ATK buffs",
      "ATK buff only applies for attack-type AoE abilities"
    ],
    "edge_cases": [
      "Buff should be applied for both AoE and splash damage attack abilities",
      "Buff should not be applied for non-attack AoE abilities (like healing)",
      "Buff duration should be tracked correctly across multiple turns",
      "Buff should be removed exactly after 2 turns, not before or after",
      "Multiple instances of the same buff should refresh the duration",
      "ATK buff should affect damage calculations correctly"
    ]
  }
} 